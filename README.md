# ๐จ Nano Banana Pro V2 - Production-Ready

**Telegram-ะฑะพั ะดะปั ะณะตะฝะตัะฐัะธะธ ะธะทะพะฑัะฐะถะตะฝะธะน ั ัะพััะฐะฝะตะฝะธะตะผ ะปะธัะฐ** ะฝะฐ ะพัะฝะพะฒะต Google Gemini 3 Pro Image ั ะฟะพะปะฝะพะน ะผะพะฝะตัะธะทะฐัะธะตะน ัะตัะตะท ะฎะะฐััั.

## โจ ะะปััะตะฒัะต ะฒะพะทะผะพะถะฝะพััะธ V2

### ๐ฐ ะะพะฝะตัะธะทะฐัะธั
- **ะกะธััะตะผะฐ ะบัะตะดะธัะพะฒ**: 1 ะณะตะฝะตัะฐัะธั = 10โฝ (10 ะบัะตะดะธัะพะฒ)
- **ะะฝัะตะณัะฐัะธั ั ะฎะะฐััะฐ**: ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะฝะฐัะธัะปะตะฝะธะต ะบัะตะดะธัะพะฒ
- **ะขัะฐะฝะทะฐะบัะธะพะฝะฝะฐั ัะธััะตะผะฐ**: Reserve/Commit/Release ะดะปั ะทะฐัะธัั ะพั ะดะฒะพะนะฝัั ัะฟะธัะฐะฝะธะน
- **ะะฐะบะตัั ะฟะพะฟะพะปะฝะตะฝะธั**: 100โฝ, 200โฝ, 300โฝ

### ๐ ะะฐัััะฐะฑะธััะตะผะพััั
- **Webhook ะฒะผะตััะพ polling**: ะพะฑัะฐะฑะพัะบะฐ ะดะพ 1000+ ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- **ะัะธะฝััะพะฝะฝัะต ะพัะตัะตะดะธ**: Redis ะดะปั ะทะฐะดะฐั ะณะตะฝะตัะฐัะธะธ
- **ะะฐะทะดะตะปะตะฝะธะต ัะตัะฒะธัะพะฒ**: Bot API + Worker
- **PostgreSQL**: ะฝะฐะดะตะถะฝะพะต ััะฐะฝะตะฝะธะต ะดะฐะฝะฝัั

### ๐ ะะฐะดะตะถะฝะพััั
- **ะะดะตะผะฟะพัะตะฝัะฝะพััั ะฟะปะฐัะตะถะตะน**: ะทะฐัะธัะฐ ะพั ะดัะฑะปะธัะพะฒะฐะฝะธั
- **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ**: ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฒะพะทะฒัะฐั ะบัะตะดะธัะพะฒ
- **ะะพะณะธัะพะฒะฐะฝะธะต**: ะฟะพะปะฝะฐั ะฟัะพะทัะฐัะฝะพััั ะพะฟะตัะฐัะธะน
- **ะะพะฝะธัะพัะธะฝะณ**: ะพััะปะตะถะธะฒะฐะฝะธะต ััะฐัััะพะฒ ะธ ะพัะธะฑะพะบ

---

## ๐ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโ
โ   Telegram  โ
โโโโโโโโฌโโโโโโโ
       โ Webhook
       โผ
โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ
โ   Bot API       โโโโโโโบโ  PostgreSQL  โ
โ  (FastAPI)      โ      โโโโโโโโโโโโโโโโ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  Redis Queue    โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ
โ    Worker       โโโโโโโบโ  Gemini API  โ
โ  (Generator)    โ      โโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโ
โ    ะฎะะฐััะฐ       โ
โ   (Webhook)     โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  Payment        โ
โ  Handler        โ
โโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฆ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
nano_banana_pro/
โโโ bot_api/                    # Bot API Service
โ   โโโ main.py                 # FastAPI app
โ   โโโ bot.py                  # Telegram bot
โ   โโโ handlers/               # ะะฑัะฐะฑะพััะธะบะธ ะบะพะผะฐะฝะด
โ   โโโ services/               # ะะธะทะฝะตั-ะปะพะณะธะบะฐ
โ   โโโ webhooks/               # Webhook ะพะฑัะฐะฑะพััะธะบะธ
โโโ worker/                     # Worker Service
โ   โโโ main.py                 # Worker ะฟัะพัะตัั
โ   โโโ tasks.py                # ะะฑัะฐะฑะพัะบะฐ ะทะฐะดะฐั
โ   โโโ gemini_client.py        # Gemini API
โโโ shared/                     # ะะฑัะธะน ะบะพะด
โ   โโโ config.py               # ะะพะฝัะธะณััะฐัะธั
โ   โโโ database.py             # SQLAlchemy models
โ   โโโ redis_client.py         # Redis ะบะปะธะตะฝั
โโโ requirements/               # ะะฐะฒะธัะธะผะพััะธ
โโโ .env.example                # ะัะธะผะตั ะฟะตัะตะผะตะฝะฝัั
โโโ Procfile                    # Railway deployment
โโโ README.md
```

---

## ๐ ะัััััะน ััะฐัั

### ะะฐัะธะฐะฝั A: Railway (ะะตะบะพะผะตะฝะดัะตััั)

1. **ะกะพะทะดะฐะนัะต ะฟัะพะตะบั ะฝะฐ Railway:**
   ```bash
   # ะะฐะณััะทะธัะต ะบะพะด ะฝะฐ GitHub
   git init
   git add .
   git commit -m "Initial commit"
   git push origin main
   ```

2. **ะะพะฑะฐะฒััะต ัะตัะฒะธัั ะฒ Railway:**
   - PostgreSQL (ะฟะปะฐะณะธะฝ)
   - Redis (ะฟะปะฐะณะธะฝ)
   - Bot API (ะธะท GitHub)
   - Worker (ะธะท GitHub)

3. **ะะฐัััะพะนัะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:**
   ```
   TELEGRAM_BOT_TOKEN=...
   TELEGRAM_WEBHOOK_URL=https://your-app.railway.app/webhook/telegram
   GEMINI_API_KEY=...
   YOOKASSA_SHOP_ID=...
   YOOKASSA_SECRET_KEY=...
   YOOKASSA_WEBHOOK_URL=https://your-app.railway.app/webhook/yookassa
   ```

4. **ะะฐัััะพะนัะต webhook ะฒ ะฎะะฐััะฐ:**
   - URL: `https://your-app.railway.app/webhook/yookassa`
   - ะะบะปััะธัะต ัะฒะตะดะพะผะปะตะฝะธั ะพ ะฟะปะฐัะตะถะฐั

5. **ะะพัะพะฒะพ!** ะะพั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะฟัััะธััั.

### ะะฐัะธะฐะฝั B: ะะพะบะฐะปัะฝะฐั ัะฐะทัะฐะฑะพัะบะฐ

1. **ะฃััะฐะฝะพะฒะธัะต ะทะฐะฒะธัะธะผะพััะธ:**
   ```bash
   pip install -r requirements/base.txt
   ```

2. **ะะฐัััะพะนัะต PostgreSQL ะธ Redis:**
   ```bash
   # ะัะฟะพะปัะทัะนัะต Docker Compose
   docker-compose up -d postgres redis
   ```

3. **ะกะพะทะดะฐะนัะต .env ัะฐะนะป:**
   ```bash
   cp .env.example .env
   # ะััะตะดะฐะบัะธััะนัะต .env
   ```

4. **ะะฝะธัะธะฐะปะธะทะธััะนัะต ะะ:**
   ```bash
   python -c "from shared.database import init_db; import asyncio; asyncio.run(init_db())"
   ```

5. **ะะฐะฟัััะธัะต ัะตัะฒะธัั:**
   ```bash
   # ะขะตัะผะธะฝะฐะป 1: Bot API
   python -m bot_api.main
   
   # ะขะตัะผะธะฝะฐะป 2: Worker
   python -m worker.main
   ```

---

## ๐ณ ะะฐัััะพะนะบะฐ ะฎะะฐััะฐ

### 1. ะะพะปััะตะฝะธะต ะบะปััะตะน

1. ะะฐัะตะณะธัััะธััะนัะตัั ะฝะฐ [yookassa.ru](https://yookassa.ru)
2. ะกะพะทะดะฐะนัะต ะผะฐะณะฐะทะธะฝ
3. ะะพะปััะธัะต:
   - `shopId` (ID ะผะฐะณะฐะทะธะฝะฐ)
   - `secretKey` (ัะตะบัะตัะฝัะน ะบะปัั)

### 2. ะะฐัััะพะนะบะฐ webhook

1. ะ ะปะธัะฝะพะผ ะบะฐะฑะธะฝะตัะต ะฎะะฐััะฐ:
   - ะะฐัััะพะนะบะธ โ HTTP-ัะฒะตะดะพะผะปะตะฝะธั
   - URL: `https://your-app.railway.app/webhook/yookassa`
   - ะะบะปััะธัะต ัะฒะตะดะพะผะปะตะฝะธั ะพ ะฟะปะฐัะตะถะฐั

2. ะกะณะตะฝะตัะธััะนัะต webhook secret:
   ```bash
   python -c "import secrets; print(secrets.token_urlsafe(32))"
   ```

3. ะะพะฑะฐะฒััะต ะฒ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:
   ```
   YOOKASSA_WEBHOOK_SECRET=ะฒะฐั_webhook_secret
   ```

---

## ๐ ะะพะผะฐะฝะดั ะฑะพัะฐ

| ะะพะผะฐะฝะดะฐ | ะะฟะธัะฐะฝะธะต |
|---------|----------|
| `/start` | ะะฐัะฐัั ัะฐะฑะพัั ั ะฑะพัะพะผ |
| `/help` | ะะพะบะฐะทะฐัั ัะฟัะฐะฒะบั |
| `/balance` | ะัะพะฒะตัะธัั ะฑะฐะปะฐะฝั ะบัะตะดะธัะพะฒ |
| `/topup` | ะะพะฟะพะปะฝะธัั ะฑะฐะปะฐะฝั |
| `/prompt <ัะตะบัั>` | ะฃััะฐะฝะพะฒะธัั ะฟัะพะผะฟั ะดะปั ะณะตะฝะตัะฐัะธะธ |
| `/generate` | ะกะณะตะฝะตัะธัะพะฒะฐัั ะธะทะพะฑัะฐะถะตะฝะธะต |
| `/settings` | ะะฐัััะพะนะบะธ ะณะตะฝะตัะฐัะธะธ |
| `/refs` | ะฃะฟัะฐะฒะปะตะฝะธะต ัะตัะตัะตะฝัะฝัะผะธ ะธะทะพะฑัะฐะถะตะฝะธัะผะธ |
| `/clear` | ะัะธััะธัั ัะตัะตัะตะฝัะฝัะต ะธะทะพะฑัะฐะถะตะฝะธั |
| `/history` | ะััะพัะธั ะณะตะฝะตัะฐัะธะน |
| `/support` | ะกะฒัะทะฐัััั ั ะฟะพะดะดะตัะถะบะพะน |

---

## ๐ง ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

### ะะฑัะทะฐัะตะปัะฝัะต

```env
# Telegram
TELEGRAM_BOT_TOKEN=ะฒะฐั_ัะพะบะตะฝ_ะฑะพัะฐ
TELEGRAM_WEBHOOK_URL=https://your-app.railway.app/webhook/telegram

# Gemini
GEMINI_API_KEY=ะฒะฐั_api_ะบะปัั

# ะฎะะฐััะฐ
YOOKASSA_SHOP_ID=ะฒะฐั_shop_id
YOOKASSA_SECRET_KEY=ะฒะฐั_secret_key
YOOKASSA_WEBHOOK_URL=https://your-app.railway.app/webhook/yookassa
```

### ะะฒัะพะผะฐัะธัะตัะบะธะต (Railway)

```env
DATABASE_URL=postgresql://...  # ะะฒัะพะผะฐัะธัะตัะบะธ ะพั PostgreSQL ะฟะปะฐะณะธะฝะฐ
REDIS_URL=redis://...          # ะะฒัะพะผะฐัะธัะตัะบะธ ะพั Redis ะฟะปะฐะณะธะฝะฐ
PORT=8080                      # ะะฒัะพะผะฐัะธัะตัะบะธ ะพั Railway
```

---

## ๐ ะะฐะทะฐ ะดะฐะฝะฝัั

### ะขะฐะฑะปะธัั

- **users** - ะะพะปัะทะพะฒะฐัะตะปะธ
- **balances** - ะะฐะปะฐะฝัั ะบัะตะดะธัะพะฒ
- **topups** - ะะพะฟะพะปะฝะตะฝะธั
- **payments** - ะะปะฐัะตะถะธ ะฎะะฐััะฐ
- **generations** - ะะตะฝะตัะฐัะธะธ ะธะทะพะฑัะฐะถะตะฝะธะน
- **transactions** - ะััะพัะธั ััะฐะฝะทะฐะบัะธะน

### ะะธะณัะฐัะธะธ

```bash
# ะกะพะทะดะฐัั ะผะธะณัะฐัะธั
alembic revision --autogenerate -m "description"

# ะัะธะผะตะฝะธัั ะผะธะณัะฐัะธะธ
alembic upgrade head
```

---

## ๐ Workflow ะณะตะฝะตัะฐัะธะธ

1. **ะะพะปัะทะพะฒะฐัะตะปั ะทะฐะณััะถะฐะตั ัะพัะพ** โ ะกะพััะฐะฝัะตััั ะฒ `data/references/`
2. **ะฃััะฐะฝะฐะฒะปะธะฒะฐะตั ะฟัะพะผะฟั** โ `/prompt ัะตะบัั`
3. **ะะฐะฟััะบะฐะตั ะณะตะฝะตัะฐัะธั** โ `/generate`
4. **ะะตะทะตัะฒะธัะพะฒะฐะฝะธะต ะบัะตะดะธัะพะฒ** โ 10 ะบัะตะดะธัะพะฒ ะทะฐะผะพัะฐะถะธะฒะฐัััั
5. **ะะพััะฐะฝะพะฒะบะฐ ะฒ ะพัะตัะตะดั** โ Redis queue
6. **Worker ะพะฑัะฐะฑะฐััะฒะฐะตั** โ Gemini API
7. **ะฃัะฟะตั** โ ะัะตะดะธัั ัะฟะธััะฒะฐัััั, ะธะทะพะฑัะฐะถะตะฝะธะต ะพัะฟัะฐะฒะปัะตััั
8. **ะัะธะฑะบะฐ** โ ะัะตะดะธัั ะฒะพะทะฒัะฐัะฐัััั, ัะฒะตะดะพะผะปะตะฝะธะต ะพะฑ ะพัะธะฑะบะต

---

## ๐ฐ ะกะธััะตะผะฐ ะบัะตะดะธัะพะฒ

### Reserve/Commit/Release

```python
# Reserve - ัะตะทะตัะฒะธัะพะฒะฐะฝะธะต ะฟะตัะตะด ะณะตะฝะตัะฐัะธะตะน
await BalanceService.reserve_credits(session, user_id, 10)

# Commit - ัะฟะธัะฐะฝะธะต ะฟะพัะปะต ััะฟะตัะฐ
await BalanceService.commit_credits(session, user_id, 10, generation_id)

# Release - ะฒะพะทะฒัะฐั ะฟัะธ ะพัะธะฑะบะต
await BalanceService.release_credits(session, user_id, 10)
```

### ะะฐัะธัะฐ ะพั ะดะฒะพะนะฝะพะณะพ ัะฟะธัะฐะฝะธั

- ะฃะฝะธะบะฐะปัะฝัะน ะธะฝะดะตะบั ะฟะพ `payment_id`
- ะัะพะฒะตัะบะฐ `processed_at` ะฟะตัะตะด ะพะฑัะฐะฑะพัะบะพะน
- ะขัะฐะฝะทะฐะบัะธะธ ะดะปั ะฐัะพะผะฐัะฝะพััะธ
- ะะดะตะผะฟะพัะตะฝัะฝะพััั webhook ะพะฑัะฐะฑะพััะธะบะพะฒ

---

## ๐ ะะพะฝะธัะพัะธะฝะณ

### ะะพะณะธ

- `data/logs/bot_api.log` - Bot API ัะพะฑััะธั
- `data/logs/worker.log` - Worker ะทะฐะดะฐัะธ
- `data/logs/payments.log` - ะะปะฐัะตะถะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ)

### ะะตััะธะบะธ

- ะะพะปะธัะตััะฒะพ ะฐะบัะธะฒะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- ะะพะปะธัะตััะฒะพ ะณะตะฝะตัะฐัะธะน ะฒ ะดะตะฝั
- ะะพะฝะฒะตััะธั ะฒ ะพะฟะปะฐัั
- ะัะตะผั ะพะฑัะฐะฑะพัะบะธ ะทะฐะดะฐั
- ะัะธะฑะบะธ ะณะตะฝะตัะฐัะธะธ

---

## ๐ Troubleshooting

### ะะพั ะฝะต ะพัะฒะตัะฐะตั

1. ะัะพะฒะตัััะต webhook: `curl https://your-app.railway.app/health`
2. ะัะพะฒะตัััะต ะปะพะณะธ ะฒ Railway Dashboard
3. ะฃะฑะตะดะธัะตัั ััะพ `TELEGRAM_WEBHOOK_URL` ะฟัะฐะฒะธะปัะฝัะน

### ะะปะฐัะตะถะธ ะฝะต ะพะฑัะฐะฑะฐััะฒะฐัััั

1. ะัะพะฒะตัััะต webhook ะฒ ะฎะะฐััะฐ
2. ะัะพะฒะตัััะต `YOOKASSA_WEBHOOK_SECRET`
3. ะัะพะฒะตัััะต ะปะพะณะธ ะฟะปะฐัะตะถะตะน
4. ะฃะฑะตะดะธัะตัั ััะพ webhook URL ะดะพัััะฟะตะฝ ะธะทะฒะฝะต

### ะะตะฝะตัะฐัะธะธ ะฝะต ะทะฐะฟััะบะฐัััั

1. ะัะพะฒะตัััะต ััะพ Worker ะทะฐะฟััะตะฝ
2. ะัะพะฒะตัััะต Redis ัะพะตะดะธะฝะตะฝะธะต
3. ะัะพะฒะตัััะต `GEMINI_API_KEY`
4. ะัะพะฒะตัััะต ะปะพะณะธ worker

### ะัะตะดะธัั ะฝะต ะฝะฐัะธัะปััััั

1. ะัะพะฒะตัััะต webhook ะฎะะฐััะฐ
2. ะัะพะฒะตัััะต ัะฐะฑะปะธัั `payments` ะฒ ะะ
3. ะัะพะฒะตัััะต `processed_at` ะฒ ะฟะปะฐัะตะถะฐั
4. ะัะพะฒะตัััะต ะปะพะณะธ

---

## ๐ ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต

### ะขะตะบััะฐั ะบะพะฝัะธะณััะฐัะธั

- **Bot API**: 1 ะธะฝััะฐะฝั
- **Worker**: 1 ะธะฝััะฐะฝั
- **PostgreSQL**: Railway ะฟะปะฐะณะธะฝ
- **Redis**: Railway ะฟะปะฐะณะธะฝ

### ะะปั 1000+ ะฟะพะปัะทะพะฒะฐัะตะปะตะน

1. **ะฃะฒะตะปะธัััะต Worker ะธะฝััะฐะฝัั** (2-3)
2. **ะะฐัััะพะนัะต connection pooling** ะฒ PostgreSQL
3. **ะะพะฑะฐะฒััะต ะผะพะฝะธัะพัะธะฝะณ** (Sentry, Prometheus)
4. **ะะฐัััะพะนัะต rate limiting**
5. **ะัะฟะพะปัะทัะนัะต CDN** ะดะปั ะธะทะพะฑัะฐะถะตะฝะธะน (S3 + CloudFront)

---

## ๐ก ะัััะธะต ะฟัะฐะบัะธะบะธ

### ะะตะทะพะฟะฐัะฝะพััั

- โ ะัะต ัะพะบะตะฝั ะฒ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
- โ ะะฐะปะธะดะฐัะธั webhook ะฟะพะดะฟะธัะตะน
- โ ะะดะตะผะฟะพัะตะฝัะฝะพััั ะฟะปะฐัะตะถะตะน
- โ ะขัะฐะฝะทะฐะบัะธะธ ะดะปั ะบัะธัะธัะตัะบะธั ะพะฟะตัะฐัะธะน

### ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

- โ ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ
- โ ะัะตัะตะดะธ ะดะปั ะทะฐะดะฐั
- โ Connection pooling
- โ ะััะธัะพะฒะฐะฝะธะต ะฒ Redis

### ะะฐะดะตะถะฝะพััั

- โ ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
- โ ะะฒัะพะผะฐัะธัะตัะบะธะน ะฒะพะทะฒัะฐั ะบัะตะดะธัะพะฒ
- โ ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะพะฟะตัะฐัะธะน
- โ Retry ะผะตัะฐะฝะธะทะผั

---

## ๐ ะะธัะตะฝะทะธั

MIT License - ะธัะฟะพะปัะทัะนัะต ัะฒะพะฑะพะดะฝะพ!

---

## ๐ค ะะพะดะดะตัะถะบะฐ

ะัะปะธ ะฒะพะทะฝะธะบะปะธ ะฒะพะฟัะพัั ะธะปะธ ะฟัะพะฑะปะตะผั:

1. ะัะพะฒะตัััะต ะปะพะณะธ
2. ะะทััะธัะต ะดะพะบัะผะตะฝัะฐัะธั
3. ะะฑัะฐัะธัะตัั ะฒ ะฟะพะดะดะตัะถะบั: @Bashirov1111

---

**ะกะพะทะดะฐะฝะพ ั โค๏ธ ะดะปั ัะฐะฑะพัั ั Gemini 3 Pro Image (Nano Banana Pro)**

**Version 2.0.0 - Production-Ready**
