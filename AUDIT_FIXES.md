# üîç Audit V2 - –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üìã –°–ø–∏—Å–æ–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤–æ–∫

### ‚úÖ 1. –ñ—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç: 1 –∞–∫—Ç–∏–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª:** `shared/config.py`
```python
MAX_CONCURRENT_GENERATIONS = 1  # –ñ–Å–°–¢–ö–ò–ô –õ–ò–ú–ò–¢
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `bot_api/services/job_service.py`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–¥–∞—á–∏
- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: "‚ö†Ô∏è –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è!"

---

### ‚úÖ 2. Watchdog –¥–ª—è –∑–∞–≤–∏—Å—à–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π

**–§–∞–π–ª:** `worker/watchdog.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
- –¢–∞–π–º–∞—É—Ç: 600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** `worker/main.py`
```python
self.watchdog = Watchdog(check_interval=60)
asyncio.create_task(self.watchdog.start())
```

**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞—Ö–æ–¥–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ `processing` —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç
2. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `failed`
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã —á–µ—Ä–µ–∑ `BalanceService.release_credits()`
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

### ‚úÖ 3. Webhook –Æ–ö–∞—Å—Å–∞ –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—Ç HTTP 200

**–§–∞–π–ª:** `bot_api/webhooks/yookassa.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ–º HTTP 200 (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
return {"status": "ok"}

# –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
except Exception as e:
    logger.error(f"Error: {e}")
    return {"status": "error", "message": str(e)}  # HTTP 200
```

**–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `payment.processed_at`
- –ï—Å–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω ‚Üí no-op, –≤–æ–∑–≤—Ä–∞—Ç OK
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: "Idempotent no-op, returning OK"

---

### ‚úÖ 4. –£–ª—É—á—à–µ–Ω–Ω—ã–π UX /support

**–§–∞–π–ª:** `bot_api/handlers/commands.py`

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:**
```
üí¨ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞**

üë§ **–í–∞—à ID:** `123456789`
üìõ **Username:** @username

üì© **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ –õ–°:** @Bashirov1111

üìù **–ú—ã –ø–æ–º–æ–∂–µ–º —Å:**
‚Ä¢ –ü—Ä–æ–±–ª–µ–º–∞–º–∏ —Å –æ–ø–ª–∞—Ç–æ–π
‚Ä¢ –û—à–∏–±–∫–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
‚Ä¢ –í–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

‚ÑπÔ∏è –ü—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à ID: `123456789`
```

**–ö–Ω–æ–ø–∫–∞:** "üí¨ –ù–∞–ø–∏—Å–∞—Ç—å @Bashirov1111"

---

### ‚úÖ 5. –ì–ª–æ–±–∞–ª—å–Ω—ã–π rate limit / –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏

**–§–∞–π–ª:** `shared/config.py`
```python
MAX_QUEUE_SIZE = 100  # –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –æ—á–µ—Ä–µ–¥–∏
RATE_LIMIT_GENERATIONS_PER_HOUR = 10  # –ù–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RATE_LIMIT_TOPUP_PER_HOUR = 5
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `bot_api/services/job_service.py`

**–ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π:**
1. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –æ—á–µ—Ä–µ–¥–∏ (100 –∑–∞–¥–∞—á)
2. –õ–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π (1 –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
3. Rate limit (10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π/—á–∞—Å)
4. –ë–∞–ª–∞–Ω—Å –∫—Ä–µ–¥–∏—Ç–æ–≤

**–°–æ–æ–±—â–µ–Ω–∏—è:**
- "‚ö†Ô∏è –û—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞! –í –æ—á–µ—Ä–µ–¥–∏: 100/100 –∑–∞–¥–∞—á"
- "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π! –ú–∞–∫—Å–∏–º—É–º: 10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ —á–∞—Å"

---

### ‚úÖ 6. TTL –∏ –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–§–∞–π–ª:** `worker/cleanup.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π —á–∞—Å (3600 —Å–µ–∫—É–Ω–¥)
- –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
- –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–æ–≤ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
- –û–±–Ω—É–ª–µ–Ω–∏–µ `image_url` –≤ –ë–î

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** `shared/config.py`
```python
IMAGE_TTL_DAYS = 30
CLEANUP_INTERVAL = 3600
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** `worker/main.py`
```python
self.cleanup_service = CleanupService()
asyncio.create_task(self.cleanup_service.start())
```

**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞—Ö–æ–¥–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π —Å `image_url`
2. –£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
3. –û–±–Ω—É–ª—è–µ—Ç `image_url` –≤ –ë–î
4. –õ–æ–≥–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

---

### ‚úÖ 7. –û—Ç–º–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–§–∞–π–ª:** `bot_api/handlers/cancel.py`

**–ö–æ–º–∞–Ω–¥–∞:** `/cancel`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã
- –í–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ `cancelled`

**Callback –∫–Ω–æ–ø–∫–∏:**
- "‚úÖ –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å" ‚Üí `cancel_gen:{generation_id}`
- "‚ùå –ù–µ—Ç" ‚Üí `cancel_no`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- `bot_api/bot.py` ‚Üí CommandHandler
- `bot_api/handlers/callbacks.py` ‚Üí CallbackQueryHandler

---

### ‚úÖ 8. –ê–≤—Ç–æ-–ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –±–∞–ª–∞–Ω—Å–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–§–∞–π–ª:** `bot_api/handlers/commands.py`

**–õ–æ–≥–∏–∫–∞:**
```python
if available < GENERATION_COST:
    # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    balance_text += "\n\n‚ö†Ô∏è **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤!**\n–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å."

elif available < GENERATION_COST * 3:
    # –ë–∞–ª–∞–Ω—Å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è
    balance_text += "\n\nüîî **–ë–∞–ª–∞–Ω—Å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è!**\n–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–ø–æ–ª–Ω–∏—Ç—å."
```

**–ì–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:**
- –ö–æ–º–∞–Ω–¥–∞ `/balance`
- Callback –∫–Ω–æ–ø–∫–∞ "üí∞ –ë–∞–ª–∞–Ω—Å"

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã (3):
1. `worker/watchdog.py` - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–∏—Å—à–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
2. `worker/cleanup.py` - –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
3. `bot_api/handlers/cancel.py` - –û—Ç–º–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (6):
1. `shared/config.py` - –ù–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
2. `bot_api/services/job_service.py` - Rate limiting, –ø—Ä–æ–≤–µ—Ä–∫–∏
3. `bot_api/handlers/commands.py` - UX —É–ª—É—á—à–µ–Ω–∏—è
4. `bot_api/webhooks/yookassa.py` - HTTP 200 –≤—Å–µ–≥–¥–∞
5. `worker/main.py` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è watchdog –∏ cleanup
6. `bot_api/bot.py` - –ö–æ–º–∞–Ω–¥–∞ /cancel

### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (4):
1. ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –æ—á–µ—Ä–µ–¥–∏
2. ‚úÖ –õ–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π (1)
3. ‚úÖ Rate limit (10/—á–∞—Å)
4. ‚úÖ Timeout watchdog (10 –º–∏–Ω—É—Ç)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –õ–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
```
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å /generate
2. –°—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å /generate —Å–Ω–æ–≤–∞
3. –û–∂–∏–¥–∞–µ–º–æ: "‚ö†Ô∏è –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è!"
```

### –¢–µ—Å—Ç 2: Watchdog
```
1. –°–æ–∑–¥–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å worker (–Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å)
3. –ü–æ–¥–æ–∂–¥–∞—Ç—å 10 –º–∏–Ω—É—Ç
4. –û–∂–∏–¥–∞–µ–º–æ: –°—Ç–∞—Ç—É—Å ‚Üí failed, –∫—Ä–µ–¥–∏—Ç—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã
```

### –¢–µ—Å—Ç 3: Webhook –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
```
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å webhook –Æ–ö–∞—Å—Å–∞
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ—Ç –∂–µ webhook –ø–æ–≤—Ç–æ—Ä–Ω–æ
3. –û–∂–∏–¥–∞–µ–º–æ: HTTP 200, no-op, –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã 1 —Ä–∞–∑
```

### –¢–µ—Å—Ç 4: Rate limit
```
1. –°–¥–µ–ª–∞—Ç—å 10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∑–∞ —á–∞—Å
2. –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–¥–µ–ª–∞—Ç—å 11-—é
3. –û–∂–∏–¥–∞–µ–º–æ: "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π!"
```

### –¢–µ—Å—Ç 5: Cleanup
```
1. –°–æ–∑–¥–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –Ω–∞ 31 –¥–µ–Ω—å –Ω–∞–∑–∞–¥ (–≤ –ë–î)
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å cleanup
4. –û–∂–∏–¥–∞–µ–º–æ: –§–∞–π–ª —É–¥–∞–ª—ë–Ω, image_url = NULL
```

### –¢–µ—Å—Ç 6: –û—Ç–º–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å /generate
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å /cancel
3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–º–µ–Ω—É
4. –û–∂–∏–¥–∞–µ–º–æ: –°—Ç–∞—Ç—É—Å ‚Üí cancelled, –∫—Ä–µ–¥–∏—Ç—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã
```

### –¢–µ—Å—Ç 7: –ü–æ–¥—Å–∫–∞–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
```
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å < 10 –∫—Ä–µ–¥–∏—Ç–æ–≤
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å /balance
3. –û–∂–∏–¥–∞–µ–º–æ: "‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤!"
```

---

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (‚úÖ –í—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã):
- [x] –õ–∏–º–∏—Ç 1 –∞–∫—Ç–∏–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- [x] Watchdog –¥–ª—è –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–¥–∞—á
- [x] Webhook HTTP 200 –≤—Å–µ–≥–¥–∞
- [x] UX /support —Å user_id
- [x] Rate limiting
- [x] TTL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- [x] –û—Ç–º–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [x] –ü–æ–¥—Å–∫–∞–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- [x] –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –æ—á–µ—Ä–µ–¥–∏
- [x] Cleanup —Å–µ—Ä–≤–∏—Å
- [x] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å webhook
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞

1. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```env
   GENERATION_TIMEOUT=600
   IMAGE_TTL_DAYS=30
   CLEANUP_INTERVAL=3600
   MAX_QUEUE_SIZE=100
   RATE_LIMIT_GENERATIONS_PER_HOUR=10
   ```

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –õ–æ–≥–∏ watchdog: `data/logs/worker.log`
   - –õ–æ–≥–∏ cleanup: `data/logs/worker.log`
   - –ú–µ—Ç—Ä–∏–∫–∏: –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏, –∑–∞–≤–∏—Å—à–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

3. **–ê–ª–µ—Ä—Ç—ã:**
   - –û—á–µ—Ä–µ–¥—å > 80 –∑–∞–¥–∞—á
   - –ó–∞–≤–∏—Å—à–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π > 5
   - –û—à–∏–±–∫–∏ webhook > 10/—á–∞—Å

4. **Backup:**
   - PostgreSQL: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π backup
   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: S3 —Å lifecycle policy

---

## üéØ –ò—Ç–æ–≥

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∫–∏ –ø–æ—Å–ª–µ –∞—É–¥–∏—Ç–∞ V2 –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã. –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ production –∑–∞–ø—É—Å–∫—É —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π 1000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–í–µ—Ä—Å–∏—è:** V2.1 (Post-Audit)  
**–î–∞—Ç–∞:** 2026-02-13  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready
