# üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Nano Banana Pro V2 (Production-Ready)

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç –ø—Ä–æ—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∫ production-ready —Å–∏—Å—Ç–µ–º–µ, —Å–ø–æ—Å–æ–±–Ω–æ–π –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å 1000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–µ–π.

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è
- **1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è = 10‚ÇΩ** (10 –∫—Ä–µ–¥–∏—Ç–æ–≤)
- **1 –∫—Ä–µ–¥–∏—Ç = 1‚ÇΩ**
- –ü–∞–∫–µ—Ç—ã: 100‚ÇΩ, 200‚ÇΩ, 300‚ÇΩ
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Æ–ö–∞—Å—Å–∞
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Reserve/Commit/Release

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **1000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
- Webhook –≤–º–µ—Å—Ç–æ polling
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- –û—á–µ—Ä–µ–¥–∏ –¥–ª—è –∑–∞–¥–∞—á

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üèõ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Telegram Users                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Telegram Webhook                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Bot API Service                       ‚îÇ
‚îÇ  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π                         ‚îÇ
‚îÇ  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –º–µ–Ω—é                           ‚îÇ
‚îÇ  - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π (–Æ–ö–∞—Å—Å–∞)                           ‚îÇ
‚îÇ  - –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ                             ‚îÇ
            ‚ñº                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PostgreSQL DB     ‚îÇ       ‚îÇ    Redis Queue          ‚îÇ
‚îÇ  - users            ‚îÇ       ‚îÇ  - generation_jobs      ‚îÇ
‚îÇ  - balances         ‚îÇ       ‚îÇ  - job_results          ‚îÇ
‚îÇ  - topups           ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  - payments         ‚îÇ                   ‚îÇ
‚îÇ  - generations      ‚îÇ                   ‚ñº
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ   Worker Service        ‚îÇ
                              ‚îÇ  - Gemini API calls     ‚îÇ
                              ‚îÇ  - Image processing     ‚îÇ
                              ‚îÇ  - Result storage       ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                          ‚îÇ
                                          ‚ñº
                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ    Gemini API           ‚îÇ
                              ‚îÇ  (Google AI)            ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  –Æ–ö–∞—Å—Å–∞ Webhook                          ‚îÇ
‚îÇ  - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö                               ‚îÇ
‚îÇ  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Payment Webhook Handler                     ‚îÇ
‚îÇ  - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏                                    ‚îÇ
‚îÇ  - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞                              ‚îÇ
‚îÇ  - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
nano_banana_pro/
‚îú‚îÄ‚îÄ bot_api/                    # Bot API Service
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ bot.py                  # Telegram bot handlers
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commands.py         # –ö–æ–º–∞–Ω–¥—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ callbacks.py        # Callback –∫–Ω–æ–ø–∫–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages.py         # –°–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payments.py         # –ü–ª–∞—Ç–µ–∂–∏
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_service.py     # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ balance_service.py  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment_service.py  # –Æ–ö–∞—Å—Å–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ job_service.py      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ webhooks/
‚îÇ       ‚îú‚îÄ‚îÄ telegram.py         # Telegram webhook
‚îÇ       ‚îî‚îÄ‚îÄ yookassa.py         # –Æ–ö–∞—Å—Å–∞ webhook
‚îÇ
‚îú‚îÄ‚îÄ worker/                     # Worker Service
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # Worker –ø—Ä–æ—Ü–µ—Å—Å
‚îÇ   ‚îú‚îÄ‚îÄ tasks.py                # Celery/RQ –∑–∞–¥–∞—á–∏
‚îÇ   ‚îî‚îÄ‚îÄ gemini_client.py        # Gemini API client
‚îÇ
‚îú‚îÄ‚îÄ shared/                     # –û–±—â–∏–π –∫–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ database.py             # SQLAlchemy models
‚îÇ   ‚îú‚îÄ‚îÄ redis_client.py         # Redis connection
‚îÇ   ‚îî‚îÄ‚îÄ utils.py                # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ migrations/                 # Alembic –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ versions/
‚îÇ
‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.bot          # Bot API image
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.worker       # Worker image
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml      # –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
‚îÇ
‚îú‚îÄ‚îÄ requirements/
‚îÇ   ‚îú‚îÄ‚îÄ base.txt                # –û–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ bot.txt                 # Bot API –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ worker.txt              # Worker –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ init_db.py              # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ migrate.py              # –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ test_balance.py
‚îÇ   ‚îú‚îÄ‚îÄ test_payments.py
‚îÇ   ‚îî‚îÄ‚îÄ test_generation.py
‚îÇ
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ alembic.ini
‚îú‚îÄ‚îÄ Procfile                    # Railway deployment
‚îî‚îÄ‚îÄ README.md
```

---

## üóÑ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL)

### –¢–∞–±–ª–∏—Ü–∞: users
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    telegram_id BIGINT UNIQUE NOT NULL,
    username VARCHAR(255),
    first_name VARCHAR(255),
    registered_at TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE,
    is_premium BOOLEAN DEFAULT FALSE
);
```

### –¢–∞–±–ª–∏—Ü–∞: balances
```sql
CREATE TABLE balances (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(telegram_id) UNIQUE,
    credits_available INTEGER DEFAULT 0,
    credits_reserved INTEGER DEFAULT 0,
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### –¢–∞–±–ª–∏—Ü–∞: topups
```sql
CREATE TABLE topups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id BIGINT REFERENCES users(telegram_id),
    rub_amount DECIMAL(10,2) NOT NULL,
    credits INTEGER NOT NULL,
    status VARCHAR(50) DEFAULT 'created',
    created_at TIMESTAMP DEFAULT NOW(),
    paid_at TIMESTAMP
);
```

### –¢–∞–±–ª–∏—Ü–∞: payments
```sql
CREATE TABLE payments (
    id BIGSERIAL PRIMARY KEY,
    payment_id VARCHAR(255) UNIQUE NOT NULL,
    topup_id UUID REFERENCES topups(id),
    user_id BIGINT REFERENCES users(telegram_id),
    amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(50),
    raw_payload JSONB,
    processed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### –¢–∞–±–ª–∏—Ü–∞: generations
```sql
CREATE TABLE generations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id BIGINT REFERENCES users(telegram_id),
    job_id VARCHAR(255) UNIQUE,
    prompt TEXT NOT NULL,
    settings JSONB,
    status VARCHAR(50) DEFAULT 'pending',
    cost INTEGER DEFAULT 10,
    error TEXT,
    image_url TEXT,
    seed INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    started_at TIMESTAMP,
    completed_at TIMESTAMP
);
```

### –¢–∞–±–ª–∏—Ü–∞: transactions
```sql
CREATE TABLE transactions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(telegram_id),
    type VARCHAR(50) NOT NULL,  -- topup, generation, refund
    amount INTEGER NOT NULL,     -- –∫—Ä–µ–¥–∏—Ç—ã
    balance_before INTEGER,
    balance_after INTEGER,
    reference_id UUID,           -- topup_id –∏–ª–∏ generation_id
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## üí∞ –°–∏—Å—Ç–µ–º–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ (Reserve/Commit/Release)

### Reserve (–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ)
```python
async def reserve_credits(user_id: int, amount: int) -> bool:
    """
    –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
    """
    async with db.transaction():
        balance = await get_balance(user_id)
        if balance.credits_available >= amount:
            balance.credits_available -= amount
            balance.credits_reserved += amount
            await balance.save()
            return True
        return False
```

### Commit (–°–ø–∏—Å–∞–Ω–∏–µ)
```python
async def commit_credits(user_id: int, amount: int, generation_id: UUID):
    """
    –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    """
    async with db.transaction():
        balance = await get_balance(user_id)
        balance.credits_reserved -= amount
        await balance.save()
        
        # –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        await create_transaction(
            user_id=user_id,
            type='generation',
            amount=-amount,
            reference_id=generation_id
        )
```

### Release (–í–æ–∑–≤—Ä–∞—Ç)
```python
async def release_credits(user_id: int, amount: int):
    """
    –í–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    """
    async with db.transaction():
        balance = await get_balance(user_id)
        balance.credits_reserved -= amount
        balance.credits_available += amount
        await balance.save()
```

---

## üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Æ–ö–∞—Å—Å–∞

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
```python
async def create_payment(user_id: int, rub_amount: int):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –Æ–ö–∞—Å—Å–∞
    """
    # 1. –°–æ–∑–¥–∞–µ–º topup –∑–∞–ø–∏—Å—å
    topup = await Topup.create(
        user_id=user_id,
        rub_amount=rub_amount,
        credits=rub_amount,  # 1‚ÇΩ = 1 –∫—Ä–µ–¥–∏—Ç
        status='created'
    )
    
    # 2. –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ –≤ –Æ–ö–∞—Å—Å–∞
    payment = Payment.create({
        "amount": {
            "value": f"{rub_amount}.00",
            "currency": "RUB"
        },
        "confirmation": {
            "type": "redirect",
            "return_url": f"{BASE_URL}/payment/return"
        },
        "capture": True,
        "metadata": {
            "topup_id": str(topup.id),
            "user_id": user_id,
            "credits": rub_amount
        }
    }, uuid.uuid4())  # idempotence key
    
    # 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º payment_id
    await PaymentRecord.create(
        payment_id=payment.id,
        topup_id=topup.id,
        user_id=user_id,
        amount=rub_amount,
        status='pending'
    )
    
    return payment.confirmation.confirmation_url
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook
```python
async def handle_yookassa_webhook(payload: dict):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –Æ–ö–∞—Å—Å–∞ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
    """
    payment_id = payload['object']['id']
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    payment = await PaymentRecord.get_by_payment_id(payment_id)
    if payment.processed_at:
        return  # –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ (–≤–∞–∂–Ω–æ!)
    if not validate_yookassa_signature(payload):
        raise SecurityError("Invalid signature")
    
    status = payload['object']['status']
    
    if status == 'succeeded':
        async with db.transaction():
            # –ü–æ–ª—É—á–∞–µ–º topup
            topup = await Topup.get(payment.topup_id)
            
            # –ù–∞—á–∏—Å–ª—è–µ–º –∫—Ä–µ–¥–∏—Ç—ã
            await add_credits(
                user_id=topup.user_id,
                amount=topup.credits,
                reference_id=topup.id
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
            topup.status = 'paid'
            topup.paid_at = datetime.now()
            payment.status = 'succeeded'
            payment.processed_at = datetime.now()
            
            await topup.save()
            await payment.save()
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await send_telegram_message(
                topup.user_id,
                f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞! –ù–∞—á–∏—Å–ª–µ–Ω–æ {topup.credits} –∫—Ä–µ–¥–∏—Ç–æ–≤."
            )
```

---

## üîÑ –û—á–µ—Ä–µ–¥—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–π (Redis + RQ/Celery)

### –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏
```python
async def create_generation_job(
    user_id: int,
    prompt: str,
    reference_images: List[str],
    settings: dict
):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    """
    # 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –∫—Ä–µ–¥–∏—Ç—ã
    if not await reserve_credits(user_id, GENERATION_COST):
        raise InsufficientCreditsError()
    
    # 2. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    generation = await Generation.create(
        user_id=user_id,
        prompt=prompt,
        settings=settings,
        status='pending',
        cost=GENERATION_COST
    )
    
    # 3. –°—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å
    job = await queue.enqueue(
        'worker.tasks.generate_image',
        generation_id=str(generation.id),
        user_id=user_id,
        prompt=prompt,
        reference_images=reference_images,
        settings=settings
    )
    
    generation.job_id = job.id
    await generation.save()
    
    return generation
```

### Worker –æ–±—Ä–∞–±–æ—Ç–∫–∞
```python
@celery.task(bind=True, max_retries=3)
def generate_image(
    self,
    generation_id: str,
    user_id: int,
    prompt: str,
    reference_images: List[str],
    settings: dict
):
    """
    Worker –∑–∞–¥–∞—á–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    """
    try:
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        generation = Generation.get(generation_id)
        generation.status = 'processing'
        generation.started_at = datetime.now()
        generation.save()
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Gemini
        image_data, error, seed = gemini_client.generate_image(
            prompt=prompt,
            reference_images=reference_images,
            **settings
        )
        
        if error:
            # –û—à–∏–±–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—Ä–µ–¥–∏—Ç—ã
            release_credits(user_id, GENERATION_COST)
            generation.status = 'failed'
            generation.error = error
            generation.save()
            
            send_telegram_message(
                user_id,
                f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {error}\n"
                f"–ö—Ä–µ–¥–∏—Ç—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –±–∞–ª–∞–Ω—Å."
            )
        else:
            # –£—Å–ø–µ—Ö - —Å–ø–∏—Å—ã–≤–∞–µ–º –∫—Ä–µ–¥–∏—Ç—ã
            commit_credits(user_id, GENERATION_COST, generation_id)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            image_url = upload_to_s3(image_data, generation_id)
            
            generation.status = 'completed'
            generation.image_url = image_url
            generation.seed = seed
            generation.completed_at = datetime.now()
            generation.save()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            send_telegram_photo(
                user_id,
                image_url,
                caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ! Seed: {seed}"
            )
    
    except Exception as e:
        # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—Ä–µ–¥–∏—Ç—ã
        release_credits(user_id, GENERATION_COST)
        generation.status = 'failed'
        generation.error = str(e)
        generation.save()
        raise
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–ª–∏–¥–∞—Ü–∏—è webhook –Æ–ö–∞—Å—Å–∞
```python
def validate_yookassa_signature(payload: dict) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook –æ—Ç –Æ–ö–∞—Å—Å–∞
    """
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    signature = request.headers.get('X-Yookassa-Signature')
    
    # –í—ã—á–∏—Å–ª—è–µ–º –æ–∂–∏–¥–∞–µ–º—É—é –ø–æ–¥–ø–∏—Å—å
    expected = hmac.new(
        YOOKASSA_WEBHOOK_SECRET.encode(),
        json.dumps(payload).encode(),
        hashlib.sha256
    ).hexdigest()
    
    return hmac.compare_digest(signature, expected)
```

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ `payment_id`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `processed_at` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏
- `bot_api.log` - Bot API —Å–æ–±—ã—Ç–∏—è
- `worker.log` - Worker –∑–∞–¥–∞—á–∏
- `payments.log` - –ü–ª–∞—Ç–µ–∂–∏ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
- `errors.log` - –û—à–∏–±–∫–∏

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ –¥–µ–Ω—å
- –°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –æ–ø–ª–∞—Ç—É
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á

---

## üöÄ –î–µ–ø–ª–æ–π

### Railway
- **Bot API** - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å
- **Worker** - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å
- **PostgreSQL** - –ø–ª–∞–≥–∏–Ω
- **Redis** - –ø–ª–∞–≥–∏–Ω

### Docker Compose (–ª–æ–∫–∞–ª—å–Ω–æ)
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:15
  redis:
    image: redis:7
  bot-api:
    build: ./docker/Dockerfile.bot
  worker:
    build: ./docker/Dockerfile.worker
```

---

**–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:**
- ‚úÖ –ù–∞–¥–µ–∂–Ω—É—é –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–æ 1000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ó–∞—â–∏—Ç—É –æ—Ç –¥–≤–æ–π–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
- ‚úÖ Production-ready –∫–∞—á–µ—Å—Ç–≤–æ
