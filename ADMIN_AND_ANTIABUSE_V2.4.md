## üîß Nano Banana Pro V2.4 - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏ –ê–Ω—Ç–∏-–∞–±—É–∑

### üìã –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

---

## üõ°Ô∏è –ê–Ω—Ç–∏-–∞–±—É–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –ù–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞:

**1. –ó–∞–ø—Ä–µ—Ç —Å–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª–∞:**
- –ï—Å–ª–∏ `referrer_id == new_user_id` ‚Üí —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å –ù–ï –≤—ã–¥–∞—ë—Ç—Å—è
- –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ 20 –∫—Ä–µ–¥–∏—Ç–æ–≤ (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å)

**2. "–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–º":**
- –ï—Å–ª–∏ `user_id` —É–∂–µ –µ—Å—Ç—å –≤ –ë–î ‚Üí –Ω–∏–∫–∞–∫–∏—Ö –±–æ–Ω—É—Å–æ–≤
- –î–∞–∂–µ –µ—Å–ª–∏ —Å–Ω–æ–≤–∞ –ø—Ä–∏—à—ë–ª —Å —Ä–µ—Ñ-—Å—Å—ã–ª–∫–æ–π

**3. –õ–∏–º–∏—Ç –Ω–∞–≥—Ä–∞–¥ —Ä–µ—Ñ–µ—Ä–µ—Ä—É:**
```python
REFERRAL_REWARD_CAP_PER_DAY = 10  # –ú–∞–∫—Å–∏–º—É–º 10 —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —Å –Ω–∞–≥—Ä–∞–¥–æ–π –≤ —Å—É—Ç–∫–∏
```
- –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–∫—Ä—É—Ç–∫–∏
- –ü–ª–∞–≤–Ω—ã–π —Ä–æ—Å—Ç –±–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**4. –ü–æ—Ä–æ–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:**
```python
REFERRAL_ACTIVATION_REQUIRED = True
```
- –ù–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ‚Üí 30 –∫—Ä–µ–¥–∏—Ç–æ–≤ —Å—Ä–∞–∑—É
- –†–µ—Ñ–µ—Ä–µ—Ä—É ‚Üí 30 –∫—Ä–µ–¥–∏—Ç–æ–≤ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ **–ø–µ—Ä–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏** –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ
- –°–∏–ª—å–Ω–æ —Ä–µ–∂–µ—Ç —Ñ–µ–π–∫–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã

---

## üìä –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `users`:

**–ù–æ–≤—ã–µ –ø–æ–ª—è:**
```sql
-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
welcome_credits_granted BOOLEAN DEFAULT FALSE  -- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã –≤—ã–¥–∞–Ω—ã
referral_credits_granted BOOLEAN DEFAULT FALSE -- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã –≤—ã–¥–∞–Ω—ã

-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
is_banned BOOLEAN DEFAULT FALSE
banned_at TIMESTAMP NULL
ban_reason TEXT NULL
```

### –¢–∞–±–ª–∏—Ü–∞ `referrals` (–Ω–æ–≤–∞—è):

```sql
CREATE TABLE referrals (
    id BIGSERIAL PRIMARY KEY,
    referred_user_id BIGINT UNIQUE NOT NULL,  -- –ö—Ç–æ –ø—Ä–∏—à—ë–ª
    referrer_id BIGINT NOT NULL,              -- –ö—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª
    status ENUM('registered','activated','rewarded') DEFAULT 'registered',
    registered_at TIMESTAMP DEFAULT NOW(),
    activated_at TIMESTAMP NULL,
    rewarded_at TIMESTAMP NULL,
    
    INDEX idx_referral_referrer_status (referrer_id, status),
    INDEX idx_referral_user (referred_user_id)
);
```

**–°—Ç–∞—Ç—É—Å—ã:**
- `registered` - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è
- `activated` - –°–¥–µ–ª–∞–ª –ø–µ—Ä–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
- `rewarded` - –†–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∏–ª –Ω–∞–≥—Ä–∞–¥—É

### –¢–∞–±–ª–∏—Ü–∞ `transactions`:

**–ù–æ–≤—ã–µ —Ç–∏–ø—ã:**
```
- welcome_bonus (20 –∫—Ä–µ–¥–∏—Ç–æ–≤)
- referral_bonus (30 –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–æ–≤–æ–º—É –ø–æ —Å—Å—ã–ª–∫–µ)
- referrer_bonus (30 –∫—Ä–µ–¥–∏—Ç–æ–≤ —Ä–µ—Ñ–µ—Ä–µ—Ä—É)
- admin_adjust (—Ä—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–º)
```

---

## üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

### –ö–æ–º–∞–Ω–¥—ã:

#### `/admin`
–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏:
- üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- üí∞ –ë–∞–ª–∞–Ω—Å
- üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏
- üö´ –ë–∞–Ω—ã

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
```
üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 1234
üö´ –ó–∞–±–∞–Ω–µ–Ω–æ: 5
üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏–π: 5678
üí∞ –í—Å–µ–≥–æ –∫—Ä–µ–¥–∏—Ç–æ–≤: 12345
```

#### `/add_credits <user_id> <amount>`
–ù–∞—á–∏—Å–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–ü—Ä–∏–º–µ—Ä:**
```
/add_credits 123456789 100
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ 100 –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 123456789
üí≥ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 150 –∫—Ä–µ–¥–∏—Ç–æ–≤
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
```
üéÅ –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 100 –∫—Ä–µ–¥–∏—Ç–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!
```

#### `/set_credits <user_id> <amount>`
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–∏–º–µ—Ä:**
```
/set_credits 123456789 200
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123456789 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 200 –∫—Ä–µ–¥–∏—Ç–æ–≤
üìä –ë—ã–ª–æ: 150, –∏–∑–º–µ–Ω–µ–Ω–∏–µ: +50
```

#### `/user <user_id>`
–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

**–ü—Ä–∏–º–µ—Ä:**
```
/user 123456789
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789

–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
‚Ä¢ Username: @username
‚Ä¢ –ò–º—è: –ò–≤–∞–Ω
‚Ä¢ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: 13.02.2026 10:30
‚Ä¢ –°—Ç–∞—Ç—É—Å: ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω

–ë–∞–ª–∞–Ω—Å:
‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: 150 –∫—Ä–µ–¥–∏—Ç–æ–≤
‚Ä¢ –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ: 10 –∫—Ä–µ–¥–∏—Ç–æ–≤
‚Ä¢ –í—Å–µ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–æ: 300 –∫—Ä–µ–¥–∏—Ç–æ–≤

–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:
‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏–π: 15
‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: 3

–†–µ—Ñ–µ—Ä–∞–ª:
‚Ä¢ –ü—Ä–∏–≥–ª–∞—Å–∏–ª: 987654321

–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
‚Ä¢ ‚úÖ 13.02 10:25 - completed
‚Ä¢ ‚úÖ 13.02 09:15 - completed
‚Ä¢ ‚ùå 13.02 08:00 - failed
‚Ä¢ ‚úÖ 12.02 18:30 - completed
‚Ä¢ ‚úÖ 12.02 15:20 - completed
```

#### `/ban <user_id> [–ø—Ä–∏—á–∏–Ω–∞]`
–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–∏–º–µ—Ä:**
```
/ban 123456789 –ù–∞–∫—Ä—É—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 –∑–∞–±–∞–Ω–µ–Ω
üìù –ü—Ä–∏—á–∏–Ω–∞: –ù–∞–∫—Ä—É—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
```
üö´ –í—ã –±—ã–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.

–ü—Ä–∏—á–∏–Ω–∞: –ù–∞–∫—Ä—É—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

–î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: @Bashirov1111
```

#### `/unban <user_id>`
–†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–∏–º–µ—Ä:**
```
/unban 123456789
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456789 —Ä–∞–∑–±–∞–Ω–µ–Ω
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
```
‚úÖ –í—ã –±—ã–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –ú–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º!
```

---

## üõ°Ô∏è Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞

**–§–∞–π–ª:** `bot_api/middleware/ban_check.py`

**–§—É–Ω–∫—Ü–∏—è:** `check_user_banned()`

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–±–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞:
```
üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã

–ü—Ä–∏—á–∏–Ω–∞: –ù–∞–∫—Ä—É—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

–î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: @Bashirov1111
```

---

## üîÑ –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

**–§–∞–π–ª:** `bot_api/services/referral_service_v2.py`

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

#### `create_user_with_referral()`
–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

**–õ–æ–≥–∏–∫–∞:**
```python
if referrer_code:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ–ª—å–∑—è –±—ã—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º —Å–∞–º–æ–≥–æ —Å–µ–±—è
    if referrer_id == telegram_id:
        referrer_id = None
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
    if not referrer_exists:
        referrer_id = None
    
    if referrer_id:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ
        bonus = 30 –∫—Ä–µ–¥–∏—Ç–æ–≤
        
        # –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å —Ä–µ—Ñ–µ—Ä–∞–ª–∞
        referral = Referral(
            referred_user_id=telegram_id,
            referrer_id=referrer_id,
            status=ReferralStatus.REGISTERED
        )
        
        # –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Å—Ä–∞–∑—É –Ω–∞–≥—Ä–∞–∂–¥–∞–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
        if not REFERRAL_ACTIVATION_REQUIRED:
            await _reward_referrer(referrer_id, telegram_id)
else:
    # –û–±—ã—á–Ω—ã–π –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    bonus = 20 –∫—Ä–µ–¥–∏—Ç–æ–≤
```

#### `activate_referral(user_id)`
–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤:** `worker/tasks.py` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–õ–æ–≥–∏–∫–∞:**
```python
if REFERRAL_ACTIVATION_REQUIRED:
    # –ò—â–µ–º –∑–∞–ø–∏—Å—å —Ä–µ—Ñ–µ—Ä–∞–ª–∞
    referral = find_referral(user_id, status=REGISTERED)
    
    if referral:
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        referral.status = ACTIVATED
        referral.activated_at = now()
        
        # –ù–∞–≥—Ä–∞–∂–¥–∞–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–æ–≤)
        rewarded = await _reward_referrer(referral.referrer_id, user_id)
        
        if rewarded:
            referral.status = REWARDED
            referral.rewarded_at = now()
```

#### `_reward_referrer(referrer_id, referred_user_id)`
–ù–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–æ–≤

**–õ–æ–≥–∏–∫–∞:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç
today_rewards = count_rewards_today(referrer_id)

if today_rewards >= REFERRAL_REWARD_CAP_PER_DAY:
    logger.warning(f"Referrer {referrer_id} reached daily cap")
    return False

# –ù–∞—á–∏—Å–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—É
await BalanceService.add_credits(
    user_id=referrer_id,
    amount=30,
    transaction_type="referrer_bonus"
)

# –£–≤–µ–¥–æ–º–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
await send_message(
    referrer_id,
    "üéâ –í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª—Å—è!\n\n–í—ã –ø–æ–ª—É—á–∏–ª–∏ 30 –∫—Ä–µ–¥–∏—Ç–æ–≤."
)

return True
```

---

## üéØ Workflow —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã V2

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ (—Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /start ref_123456789
    ‚Üì
2. ReferralServiceV2.create_user_with_referral()
    ‚Üì
3. –°–æ–∑–¥–∞–Ω–∏–µ User (referred_by = 123456789)
    ‚Üì
4. –°–æ–∑–¥–∞–Ω–∏–µ Balance
    ‚Üì
5. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ 30 –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    ‚Üì
6. –°–æ–∑–¥–∞–Ω–∏–µ Referral (status = REGISTERED)
    ‚Üì
7. –ü–æ–∫–∞–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è: "üéâ –í—ã –ø–æ–ª—É—á–∏–ª–∏ 30 –∫—Ä–µ–¥–∏—Ç–æ–≤!"
    ‚Üì
8. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    ‚Üì
9. worker/tasks.py ‚Üí activate_referral(user_id)
    ‚Üì
10. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
    ‚Üì
11. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ 30 –∫—Ä–µ–¥–∏—Ç–æ–≤ —Ä–µ—Ñ–µ—Ä–µ—Ä—É
    ‚Üì
12. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Referral (status = REWARDED)
    ‚Üì
13. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–µ—Ä—É: "üéâ –í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª—Å—è!"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ø—ã—Ç–∫–∞ —Å–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /start ref_<—Å–≤–æ–π_id>
    ‚Üì
2. ReferralServiceV2.create_user_with_referral()
    ‚Üì
3. –ü—Ä–æ–≤–µ—Ä–∫–∞: referrer_id == telegram_id
    ‚Üì
4. referrer_id = None
    ‚Üì
5. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ 20 –∫—Ä–µ–¥–∏—Ç–æ–≤ (–æ–±—ã—á–Ω—ã–π –±–æ–Ω—É—Å)
    ‚Üì
6. –ü–æ–∫–∞–∑: "üéÅ –í—ã –ø–æ–ª—É—á–∏–ª–∏ 20 –∫—Ä–µ–¥–∏—Ç–æ–≤ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é!"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞

```
1. –†–µ—Ñ–µ—Ä–µ—Ä —É–∂–µ –ø–æ–ª—É—á–∏–ª –Ω–∞–≥—Ä–∞–¥—É –∑–∞ 10 —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —Å–µ–≥–æ–¥–Ω—è
    ‚Üì
2. 11-–π —Ä–µ—Ñ–µ—Ä–∞–ª –¥–µ–ª–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    ‚Üì
3. activate_referral() ‚Üí _reward_referrer()
    ‚Üì
4. –ü—Ä–æ–≤–µ—Ä–∫–∞: today_rewards >= 10
    ‚Üì
5. return False (–Ω–∞–≥—Ä–∞–¥–∞ –ù–ï –≤—ã–¥–∞–Ω–∞)
    ‚Üì
6. Referral –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ ACTIVATED
    ‚Üì
7. –ù–∞–≥—Ä–∞–¥–∞ –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å (–ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

### SQL –∑–∞–ø—Ä–æ—Å—ã:

#### –¢–æ–ø-10 —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤
```sql
SELECT 
    u.telegram_id,
    u.username,
    COUNT(r.id) as referrals_count,
    COUNT(CASE WHEN r.status = 'rewarded' THEN 1 END) as rewarded_count
FROM users u
LEFT JOIN referrals r ON r.referrer_id = u.telegram_id
GROUP BY u.telegram_id, u.username
ORDER BY referrals_count DESC
LIMIT 10;
```

#### –ö–æ–Ω–≤–µ—Ä—Å–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
```sql
SELECT 
    COUNT(CASE WHEN referred_by IS NOT NULL THEN 1 END) as referral_users,
    COUNT(*) as total_users,
    ROUND(100.0 * COUNT(CASE WHEN referred_by IS NOT NULL THEN 1 END) / COUNT(*), 2) as conversion_rate
FROM users;
```

#### –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
```sql
SELECT 
    COUNT(CASE WHEN status = 'registered' THEN 1 END) as registered,
    COUNT(CASE WHEN status = 'activated' THEN 1 END) as activated,
    COUNT(CASE WHEN status = 'rewarded' THEN 1 END) as rewarded,
    ROUND(100.0 * COUNT(CASE WHEN status = 'rewarded' THEN 1 END) / COUNT(*), 2) as activation_rate
FROM referrals;
```

---

## ‚úÖ –ò—Ç–æ–≥–∏ V2.4

### –î–æ–±–∞–≤–ª–µ–Ω–æ:

**1. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:**
- ‚úÖ `/admin` - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- ‚úÖ `/add_credits` - –Ω–∞—á–∏—Å–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã
- ‚úÖ `/set_credits` - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
- ‚úÖ `/user` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- ‚úÖ `/ban` - –∑–∞–±–∞–Ω–∏—Ç—å
- ‚úÖ `/unban` - —Ä–∞–∑–±–∞–Ω–∏—Ç—å

**2. –ê–Ω—Ç–∏-–∞–±—É–∑:**
- ‚úÖ –ó–∞–ø—Ä–µ—Ç —Å–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª–∞
- ‚úÖ "–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–º" (–±–æ–Ω—É—Å—ã –æ–¥–∏–Ω —Ä–∞–∑)
- ‚úÖ –õ–∏–º–∏—Ç –Ω–∞–≥—Ä–∞–¥: 10 —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤/–¥–µ–Ω—å
- ‚úÖ –ü–æ—Ä–æ–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (–Ω–∞–≥—Ä–∞–¥–∞ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)

**3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ `users.welcome_credits_granted`
- ‚úÖ `users.referral_credits_granted`
- ‚úÖ `users.is_banned`
- ‚úÖ `users.banned_at`
- ‚úÖ `users.ban_reason`
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `referrals`

**4. –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `bot_api/handlers/admin.py` (400+ —Å—Ç—Ä–æ–∫)
- `bot_api/services/referral_service_v2.py` (300+ —Å—Ç—Ä–æ–∫)
- `bot_api/middleware/ban_check.py` (50 —Å—Ç—Ä–æ–∫)
- `shared/referral_model.py` (40 —Å—Ç—Ä–æ–∫)

**5. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `shared/database.py` - –Ω–æ–≤—ã–µ –ø–æ–ª—è
- `shared/config.py` - –ª–∏–º–∏—Ç—ã —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
- `bot_api/bot.py` - –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã
- `bot_api/handlers/commands.py` - ReferralServiceV2
- `bot_api/handlers/referrals.py` - ReferralServiceV2
- `worker/tasks.py` - –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

---

## üéâ –ì–æ—Ç–æ–≤–æ –∫ production!

**Nano Banana Pro V2.4** —Å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é –∏ –∞–Ω—Ç–∏-–∞–±—É–∑–æ–º –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É!

**–í–µ—Ä—Å–∏—è:** V2.4 (Admin Panel & Anti-Abuse)  
**–î–∞—Ç–∞:** 2026-02-13  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Ready for Production
